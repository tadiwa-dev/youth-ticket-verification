<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Ticket Scanner</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="QR Scanner">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #reader {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            display: none;
        }

        .result.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .loading {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 15px;
            border: 2px solid #bbdefb;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .start-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
        }

        .start-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ðŸŽ« QR Ticket Scanner</div>
        
        <div id="reader"></div>
        
        <button id="startBtn" class="start-btn">Start Scanner</button>
        
        <div id="status" class="status"></div>
        
        <div id="mobile-help" style="margin-top: 15px; padding: 15px; background: #fff3cd; color: #856404; border-radius: 10px; border: 1px solid #ffeaa7; font-size: 14px; display: none;">
            <strong>ðŸ“± Mobile Camera Access:</strong><br>
            â€¢ Tap "Allow" when prompted for camera permission<br>
            â€¢ If no prompt appears, check your browser settings<br>
            â€¢ Try refreshing the page if camera doesn't start
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            Validating ticket...
        </div>
        
        <div id="result" class="result"></div>
        
        <!-- Scanned Information Display -->
        <div id="scanned-info" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #dee2e6; display: none;">
            <h4 style="margin-bottom: 10px; color: #495057;">ðŸ“‹ Scanned Information</h4>
            <div style="text-align: left; font-size: 14px;">
                <div><strong>Ticket Number:</strong> <span id="scanned-ticket"></span></div>
                <div><strong>Name:</strong> <span id="scanned-name"></span></div>
                <div><strong>Church:</strong> <span id="scanned-church"></span></div>
                <div><strong>EcoCash Ref:</strong> <span id="scanned-ecocash"></span></div>
            </div>
        </div>
    </div>

    <script>
        let html5QrCode = null;
        let isScanning = false;

        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const mobileHelp = document.getElementById('mobile-help');
        const scannedInfo = document.getElementById('scanned-info');
        const scannedTicket = document.getElementById('scanned-ticket');
        const scannedName = document.getElementById('scanned-name');
        const scannedChurch = document.getElementById('scanned-church');
        const scannedEcocash = document.getElementById('scanned-ecocash');
        
        // Show mobile help on mobile devices
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            mobileHelp.style.display = 'block';
        }

        startBtn.addEventListener('click', () => {
            if (!isScanning) {
                startScanner();
            } else {
                stopScanner();
            }
        });

        function startScanner() {
            status.textContent = 'Requesting camera permission...';
            
            // Use the basic Html5Qrcode directly
            try {
                html5QrCode = new Html5Qrcode("reader");
                
                // Try to start with default camera (environment-facing camera)
                html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    onScanSuccess,
                    onScanFailure
                ).then(() => {
                    isScanning = true;
                    startBtn.textContent = 'Stop Scanner';
                    startBtn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                    status.textContent = 'Scanner active - Point camera at QR code';
                    result.style.display = 'none';
                }).catch(err => {
                    console.error('Scanner start error:', err);
                    
                    // Provide specific guidance based on error type
                    if (err.name === 'NotAllowedError') {
                        status.textContent = 'Camera access denied. Please allow camera permissions in your browser settings and try again.';
                    } else if (err.name === 'NotFoundError') {
                        status.textContent = 'No camera found. Please check if your device has a camera.';
                    } else if (err.name === 'NotSupportedError') {
                        status.textContent = 'Camera not supported. Please try a different browser.';
                    } else {
                        status.textContent = 'Error starting camera. Please check permissions and try again.';
                    }
                    
                    isScanning = false;
                    startBtn.textContent = 'Start Scanner';
                    startBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                });
            } catch (error) {
                console.error('Scanner initialization error:', error);
                status.textContent = 'Error starting scanner. Please check camera permissions.';
                isScanning = false;
                startBtn.textContent = 'Start Scanner';
                startBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            }
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                }).catch(err => {
                    console.error('Error stopping scanner:', err);
                    html5QrCode = null;
                });
            }
            
            isScanning = false;
            startBtn.textContent = 'Start Scanner';
            startBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            status.textContent = 'Scanner stopped';
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Code scanned:', decodedText);
            
            // Stop scanning after successful scan
            stopScanner();
            
            // Parse the QR code data
            const fields = decodedText.split('|');
            
            if (fields.length !== 4) {
                showResult('âŒ Invalid QR code format. Expected 4 fields separated by |', false);
                return;
            }

            const [ticketNumber, name, church, ecoCashRef] = fields.map(field => field.trim());
            
            // Display scanned information
            displayScannedInfo(ticketNumber, name, church, ecoCashRef);
            
            // Show loading
            loading.style.display = 'block';
            result.style.display = 'none';
            
            // Validate against Google Apps Script
            validateTicket(ticketNumber, ecoCashRef, name, church);
        }

        function displayScannedInfo(ticketNumber, name, church, ecoCashRef) {
            scannedTicket.textContent = ticketNumber;
            scannedName.textContent = name;
            scannedChurch.textContent = church;
            scannedEcocash.textContent = ecoCashRef;
            scannedInfo.style.display = 'block';
        }

        function onScanFailure(error) {
            // Handle scan failure silently
            console.warn('Scan failed:', error);
        }

        // Function to clear cached tickets
        function clearCachedTickets() {
            localStorage.removeItem('tickets');
        }

        async function validateTicket(ticketNumber, ecoCashRef, name, church) {
            try {
                const fullQrString = `${ticketNumber} | ${name} | ${church} | ${ecoCashRef}`;
                const url = `https://script.google.com/macros/s/AKfycbwguKy88PFo1wJz-1l1nZtqyJqpyWArgVZ_pIt-0gtwBFn3J4z44XhIdxKeHu2s04E/exec?qr=${encodeURIComponent(fullQrString)}`;
                
                // Add timeout to the fetch request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                try {
                    const response = await fetch(url, {
                        signal: controller.signal,
                        mode: 'cors'
                    });
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const responseText = await response.text();
                        loading.style.display = 'none';
                        
                        // Check for exact text matches
                        const trimmedResponse = responseText.trim();
                        
                        if (trimmedResponse === 'VALID') {
                            showResult('âœ… Ticket is valid.', true);
                            return;
                        } else if (trimmedResponse === 'ALREADY_SCANNED') {
                            showResult('âš ï¸ Ticket has already been scanned.', false);
                            return;
                        } else if (trimmedResponse === 'INVALID') {
                            showResult('âŒ Ticket not found or invalid.', false);
                            return;
                        }
                        
                        // Check for case-insensitive matches
                        const lowerResponse = responseText.toLowerCase().trim();
                        
                        if (lowerResponse === 'valid') {
                            showResult('âœ… Ticket is valid.', true);
                            return;
                        } else if (lowerResponse === 'already_scanned') {
                            showResult('âš ï¸ Ticket has already been scanned.', false);
                            return;
                        } else if (lowerResponse === 'invalid') {
                            showResult('âŒ Ticket not found or invalid.', false);
                            return;
                        }
                        
                        // Check for partial matches
                        if (lowerResponse.includes('valid') && !lowerResponse.includes('invalid') && !lowerResponse.includes('not valid')) {
                            showResult('âœ… Ticket is valid.', true);
                            return;
                        } else if (lowerResponse.includes('already_scanned')) {
                            showResult('âš ï¸ Ticket has already been scanned.', false);
                            return;
                        } else if (lowerResponse.includes('invalid') || lowerResponse.includes('not valid')) {
                            showResult('âŒ Ticket not found or invalid.', false);
                            return;
                        } else {
                            showResult('âŒ Unable to validate ticket - Server response format error.', false);
                            return;
                        }
                    } else {
                        showResult('âŒ Unable to validate ticket - Server error.', false);
                        return;
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    
                    if (fetchError.name === 'AbortError') {
                        showResult('âŒ Unable to validate ticket - Request timeout.', false);
                    } else if (fetchError.name === 'TypeError') {
                        showResult('âŒ Unable to validate ticket - Network error.', false);
                    } else {
                        showResult('âŒ Unable to validate ticket - Connection error.', false);
                    }
                    return;
                }
                
            } catch (error) {
                showResult('âŒ Unable to validate ticket - Validation error.', false);
            }
        }

        function showResult(message, isSuccess) {
            result.textContent = message;
            result.className = `result ${isSuccess ? 'success' : 'error'}`;
            result.style.display = 'block';
            
            // Auto-restart scanner after 3 seconds
            setTimeout(() => {
                if (!isScanning) {
                    // Hide scanned info when restarting
                    scannedInfo.style.display = 'none';
                    startScanner();
                }
            }, 3000);
        }

        // Auto-start scanner when page loads
        window.addEventListener('load', () => {
            // Clear any cached tickets to force fresh validation
            clearCachedTickets();
            
            setTimeout(() => {
                startScanner();
            }, 1000);
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html> 